
<!DOCTYPE html>

<html lang="zh-TW" data-content_root="./">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="viewport" content="width=device-width, initial-scale=1" />

    <title>How To Add A Constrained Floating-Point Intrinsic &#8212; LLVM  說明文件</title>
    <link rel="stylesheet" type="text/css" href="_static/pygments.css?v=d75fae25" />
    <link rel="stylesheet" type="text/css" href="_static/llvm-theme.css?v=4c4af0c1" />
    <script src="_static/documentation_options.js?v=0d9984b1"></script>
    <script src="_static/doctools.js?v=9bcbadda"></script>
    <script src="_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="_static/translations.js?v=cbf116e0"></script>
    <link rel="canonical" href="https://projects.localizethedocs.org/llvm-docs-l10n/AddingConstrainedIntrinsics.html" />
    <link rel="index" title="索引" href="genindex.html" />
    <link rel="search" title="搜尋" href="search.html" />
    <link rel="next" title="LLVM Admin Tasks" href="AdminTasks.html" />
    <link rel="prev" title="Support for AArch64 Scalable Matrix Extension in LLVM" href="AArch64SME.html" />
<script type="text/javascript" src="ltd-provenance.js"></script>
<script type="text/javascript" src="ltd-current.js"></script>
<script type="text/javascript" src="../../ltd-config.js"></script>
<script type="text/javascript" src="../../ltd-flyout.js"></script>

  </head><body>
<div class="logo">
  <a href="index.html">
    <img src="_static/logo.png"
         alt="LLVM Logo" width="250" height="88"/></a>
</div>

    <div class="related" role="navigation" aria-label="Related">
      <h3>瀏覽</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="genindex.html" title="總索引"
             accesskey="I">索引</a></li>
        <li class="right" >
          <a href="AdminTasks.html" title="LLVM Admin Tasks"
             accesskey="N">下一頁</a> |</li>
        <li class="right" >
          <a href="AArch64SME.html" title="Support for AArch64 Scalable Matrix Extension in LLVM"
             accesskey="P">上一頁</a> |</li>
  <li><a href="https://llvm.org/">LLVM Home</a>&nbsp;|&nbsp;</li>
  <li><a href="index.html">Documentation</a>&raquo;</li>

          <li class="nav-item nav-item-1"><a href="UserGuides.html" accesskey="U">使用者指南</a> &#187;</li>
        <li class="nav-item nav-item-this"><a href="">How To Add A Constrained Floating-Point Intrinsic</a></li> 
      </ul>
    </div>

      <div class="sphinxsidebar" role="navigation" aria-label="Main">
        <div class="sphinxsidebarwrapper">

<h3>Documentation</h3>

<ul class="want-points">
    <li><a href="GettingStartedTutorials.html">Getting Started/Tutorials</a></li>
    <li><a href="UserGuides.html">使用者指南</a></li>
    <li><a href="Reference.html">Reference</a></li>
</ul>

<h3>Getting Involved</h3>

<ul class="want-points">
    <li><a href="Contributing.html">Contributing to LLVM</a></li>
    <li><a href="HowToSubmitABug.html">Submitting Bug Reports</a></li>
    <li><a href="GettingInvolved.html#mailing-lists">Mailing Lists</a></li>
    <li><a href="GettingInvolved.html#discord">Discord</a></li>
    <li><a href="GettingInvolved.html#meetups-and-social-events">Meetups and Social Events</a></li>
</ul>

<h3>Additional Links</h3>

<ul class="want-points">
    <li><a href="FAQ.html">FAQ</a></li>
    <li><a href="Lexicon.html">Glossary</a></li>
    <li><a href="https://llvm.org/pubs">Publications</a></li>
    <li><a href="https://github.com/llvm/llvm-project/">Github Repository</a></li>
</ul>
  <div role="note" aria-label="source link">
    <h3>本頁</h3>
    <ul class="this-page-menu">
      <li><a href="_sources/AddingConstrainedIntrinsics.rst.txt"
            rel="nofollow">顯示原始碼</a></li>
    </ul>
   </div>
<search id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">快速搜尋</h3>
    <div class="searchformwrapper">
    <form class="search" action="search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false"/>
      <input type="submit" value="前往" />
    </form>
    </div>
</search>
<script>document.getElementById('searchbox').style.display = "block"</script>
        </div>
      </div>

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <section id="how-to-add-a-constrained-floating-point-intrinsic">
<h1>How To Add A Constrained Floating-Point Intrinsic<a class="headerlink" href="#how-to-add-a-constrained-floating-point-intrinsic" title="連結到這個標頭">¶</a></h1>
<nav class="contents local" id="id1">
<ul class="simple">
<li><p><a class="reference internal" href="#add-the-intrinsic" id="id2">Add the intrinsic</a></p></li>
<li><p><a class="reference internal" href="#add-selectiondag-node-types" id="id3">Add SelectionDAG node types</a></p></li>
<li><p><a class="reference internal" href="#update-mappings" id="id4">Update mappings</a></p></li>
<li><p><a class="reference internal" href="#update-ir-components" id="id5">Update IR components</a></p></li>
<li><p><a class="reference internal" href="#update-selector-components" id="id6">Update Selector components</a></p>
<ul>
<li><p><a class="reference internal" href="#building-the-selectiondag" id="id7">Building the SelectionDAG</a></p></li>
</ul>
</li>
<li><p><a class="reference internal" href="#add-documentation-and-tests" id="id8">Add documentation and tests</a></p></li>
</ul>
</nav>
<div class="admonition warning">
<p class="admonition-title">警告</p>
<p>This is a work in progress.</p>
</div>
<section id="add-the-intrinsic">
<h2><a class="toc-backref" href="#id2" role="doc-backlink">Add the intrinsic</a><a class="headerlink" href="#add-the-intrinsic" title="連結到這個標頭">¶</a></h2>
<p>Multiple files need to be updated when adding a new constrained intrinsic.</p>
<p>Add the new intrinsic to the table of intrinsics:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">include</span><span class="o">/</span><span class="n">llvm</span><span class="o">/</span><span class="n">IR</span><span class="o">/</span><span class="n">Intrinsics</span><span class="o">.</span><span class="n">td</span>
</pre></div>
</div>
</section>
<section id="add-selectiondag-node-types">
<h2><a class="toc-backref" href="#id3" role="doc-backlink">Add SelectionDAG node types</a><a class="headerlink" href="#add-selectiondag-node-types" title="連結到這個標頭">¶</a></h2>
<p>Add the new <code class="docutils literal notranslate"><span class="pre">STRICT</span></code> version of the node type to the <code class="docutils literal notranslate"><span class="pre">ISD::NodeType</span></code> enum:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">include</span><span class="o">/</span><span class="n">llvm</span><span class="o">/</span><span class="n">CodeGen</span><span class="o">/</span><span class="n">ISDOpcodes</span><span class="o">.</span><span class="n">h</span>
</pre></div>
</div>
<p>Strict version name must be a concatenation of prefix <code class="docutils literal notranslate"><span class="pre">STRICT_</span></code> and the name
of the corresponding non-strict node name. For instance, strict version of the
node <code class="docutils literal notranslate"><span class="pre">FADD</span></code> must be <code class="docutils literal notranslate"><span class="pre">STRICT_FADD</span></code>.</p>
</section>
<section id="update-mappings">
<h2><a class="toc-backref" href="#id4" role="doc-backlink">Update mappings</a><a class="headerlink" href="#update-mappings" title="連結到這個標頭">¶</a></h2>
<p>Add new record to the mapping of instructions to constrained intrinsic and
DAG nodes:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">include</span><span class="o">/</span><span class="n">llvm</span><span class="o">/</span><span class="n">IR</span><span class="o">/</span><span class="n">ConstrainedOps</span><span class="o">.</span><span class="k">def</span>
</pre></div>
</div>
<p>Follow instructions provided in this file.</p>
</section>
<section id="update-ir-components">
<h2><a class="toc-backref" href="#id5" role="doc-backlink">Update IR components</a><a class="headerlink" href="#update-ir-components" title="連結到這個標頭">¶</a></h2>
<p>Update the IR verifier:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">lib</span><span class="o">/</span><span class="n">IR</span><span class="o">/</span><span class="n">Verifier</span><span class="o">.</span><span class="n">cpp</span>
</pre></div>
</div>
</section>
<section id="update-selector-components">
<h2><a class="toc-backref" href="#id6" role="doc-backlink">Update Selector components</a><a class="headerlink" href="#update-selector-components" title="連結到這個標頭">¶</a></h2>
<section id="building-the-selectiondag">
<h3><a class="toc-backref" href="#id7" role="doc-backlink">Building the SelectionDAG</a><a class="headerlink" href="#building-the-selectiondag" title="連結到這個標頭">¶</a></h3>
<p>The <code class="docutils literal notranslate"><span class="pre">SelectionDAGBuilder::visitConstrainedFPIntrinsic</span></code> function builds DAG nodes
using mappings specified in <code class="docutils literal notranslate"><span class="pre">ConstrainedOps.def</span></code>. If however this default build is
not sufficient, the build can be modified, see how it is implemented for
<code class="docutils literal notranslate"><span class="pre">STRICT_FP_ROUND</span></code>. The new <code class="docutils literal notranslate"><span class="pre">STRICT</span></code> node will eventually be converted
to the matching non-<code class="docutils literal notranslate"><span class="pre">STRICT</span></code> node. For this reason it should have the same
operands and values as the non-<code class="docutils literal notranslate"><span class="pre">STRICT</span></code> version but should also use the chain.
This makes subsequent sharing of code for <code class="docutils literal notranslate"><span class="pre">STRICT</span></code> and non-<code class="docutils literal notranslate"><span class="pre">STRICT</span></code> code paths
easier:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">lib</span><span class="o">/</span><span class="n">CodeGen</span><span class="o">/</span><span class="n">SelectionDAG</span><span class="o">/</span><span class="n">SelectionDAGBuilder</span><span class="o">.</span><span class="n">cpp</span>
</pre></div>
</div>
<p>Most of the <code class="docutils literal notranslate"><span class="pre">STRICT</span></code> nodes get legalized the same as their matching non-<code class="docutils literal notranslate"><span class="pre">STRICT</span></code>
counterparts. A new <code class="docutils literal notranslate"><span class="pre">STRICT</span></code> node with this property must get added to the
switch in <code class="docutils literal notranslate"><span class="pre">SelectionDAGLegalize::LegalizeOp()</span></code>:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">lib</span><span class="o">/</span><span class="n">CodeGen</span><span class="o">/</span><span class="n">SelectionDAG</span><span class="o">/</span><span class="n">LegalizeDAG</span><span class="o">.</span><span class="n">cpp</span>
</pre></div>
</div>
<p>Other parts of the legalizer may need to be updated as well. Look for
places where the non-<code class="docutils literal notranslate"><span class="pre">STRICT</span></code> counterpart is legalized and update as needed.
Be careful of the chain since <code class="docutils literal notranslate"><span class="pre">STRICT</span></code> nodes use it but their counterparts
often don't.</p>
<p>The conversion or mutation of the <code class="docutils literal notranslate"><span class="pre">STRICT</span></code> node to a non-<code class="docutils literal notranslate"><span class="pre">STRICT</span></code>
version of the node happens in <code class="docutils literal notranslate"><span class="pre">SelectionDAG::mutateStrictFPToFP()</span></code>. In most cases
the function can do the conversion using information from ConstrainedOps.def. Be
careful updating this function since some nodes have the same return type
as their input operand, but some are different. Both of these cases must
be properly handled:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">lib</span><span class="o">/</span><span class="n">CodeGen</span><span class="o">/</span><span class="n">SelectionDAG</span><span class="o">/</span><span class="n">SelectionDAG</span><span class="o">.</span><span class="n">cpp</span>
</pre></div>
</div>
<p>Whether the mutation happens or not depends on how the new node has been
registered in <code class="docutils literal notranslate"><span class="pre">TargetLoweringBase::initActions()</span></code>. By default, all strict nodes are
registered with Expand action:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">lib</span><span class="o">/</span><span class="n">CodeGen</span><span class="o">/</span><span class="n">TargetLoweringBase</span><span class="o">.</span><span class="n">cpp</span>
</pre></div>
</div>
<p>To make debug logs readable, it is helpful to update the SelectionDAG's
debug logger::</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">lib</span><span class="o">/</span><span class="n">CodeGen</span><span class="o">/</span><span class="n">SelectionDAG</span><span class="o">/</span><span class="n">SelectionDAGDumper</span><span class="o">.</span><span class="n">cpp</span>
</pre></div>
</div>
</section>
</section>
<section id="add-documentation-and-tests">
<h2><a class="toc-backref" href="#id8" role="doc-backlink">Add documentation and tests</a><a class="headerlink" href="#add-documentation-and-tests" title="連結到這個標頭">¶</a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">docs</span><span class="o">/</span><span class="n">LangRef</span><span class="o">.</span><span class="n">rst</span>
</pre></div>
</div>
</section>
</section>


            <div class="clearer"></div>
          </div>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="Related">
      <h3>瀏覽</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="genindex.html" title="總索引"
             >索引</a></li>
        <li class="right" >
          <a href="AdminTasks.html" title="LLVM Admin Tasks"
             >下一頁</a> |</li>
        <li class="right" >
          <a href="AArch64SME.html" title="Support for AArch64 Scalable Matrix Extension in LLVM"
             >上一頁</a> |</li>
  <li><a href="https://llvm.org/">LLVM Home</a>&nbsp;|&nbsp;</li>
  <li><a href="index.html">Documentation</a>&raquo;</li>

          <li class="nav-item nav-item-1"><a href="UserGuides.html" >使用者指南</a> &#187;</li>
        <li class="nav-item nav-item-this"><a href="">How To Add A Constrained Floating-Point Intrinsic</a></li> 
      </ul>
    </div>
    <div class="footer" role="contentinfo">
    &#169; 版權所有 2003-2025, LLVM Project.
      最後更新於 2025-11-10。
      使用 <a href="https://www.sphinx-doc.org/">Sphinx</a> 8.1.3 建立。
    </div>
  </body>
</html>