
<!DOCTYPE html>

<html lang="en-US" data-content_root="./">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="viewport" content="width=device-width, initial-scale=1" />

    <title>Scudo Hardened Allocator &#8212; LLVM 3.9 documentation</title>
    <link rel="stylesheet" type="text/css" href="_static/pygments.css?v=d75fae25" />
    <link rel="stylesheet" type="text/css" href="_static/llvm-theme.css?v=4c4af0c1" />
    <script src="_static/documentation_options.js?v=2141e1c1"></script>
    <script src="_static/doctools.js?v=9bcbadda"></script>
    <script src="_static/sphinx_highlight.js?v=dc90522c"></script>
    <link rel="canonical" href="https://projects.localizethedocs.org/llvm-docs-l10n/ScudoHardenedAllocator.html" />
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="LLVM Alias Analysis Infrastructure" href="AliasAnalysis.html" />
    <link rel="prev" title="libFuzzer – a library for coverage-guided fuzz testing." href="LibFuzzer.html" />
<script type="text/javascript" src="ltd-provenance.js"></script>
<script type="text/javascript" src="ltd-current.js"></script>
<script type="text/javascript" src="../../ltd-config.js"></script>
<script type="text/javascript" src="../../ltd-flyout.js"></script>

  </head><body>
<div class="logo">
  <a href="index.html">
    <img src="_static/logo.png"
         alt="LLVM Logo" width="250" height="88"/></a>
</div>

    <div class="related" role="navigation" aria-label="Related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="AliasAnalysis.html" title="LLVM Alias Analysis Infrastructure"
             accesskey="N">next</a> |</li>
        <li class="right" >
          <a href="LibFuzzer.html" title="libFuzzer – a library for coverage-guided fuzz testing."
             accesskey="P">previous</a> |</li>
  <li><a href="https://llvm.org/">LLVM Home</a>&nbsp;|&nbsp;</li>
  <li><a href="index.html">Documentation</a>&raquo;</li>

        <li class="nav-item nav-item-this"><a href="">Scudo Hardened Allocator</a></li> 
      </ul>
    </div>


    <div class="document">
      <div class="documentwrapper">
          <div class="body" role="main">
            
  <section id="scudo-hardened-allocator">
<h1>Scudo Hardened Allocator<a class="headerlink" href="#scudo-hardened-allocator" title="Link to this heading">¶</a></h1>
<nav class="contents local" id="contents">
<ul class="simple">
<li><p><a class="reference internal" href="#introduction" id="id1">Introduction</a></p></li>
<li><p><a class="reference internal" href="#design" id="id2">Design</a></p></li>
<li><p><a class="reference internal" href="#usage" id="id3">Usage</a></p></li>
</ul>
</nav>
<section id="introduction">
<h2><a class="toc-backref" href="#id1" role="doc-backlink">Introduction</a><a class="headerlink" href="#introduction" title="Link to this heading">¶</a></h2>
<p>The Scudo Hardened Allocator is a user-mode allocator based on LLVM Sanitizer’s
CombinedAllocator, which aims at providing additional mitigations against heap
based vulnerabilities, while maintaining good performance.</p>
<p>The name “Scudo” has been retained from the initial implementation (Escudo
meaning Shield in Spanish and Portuguese).</p>
</section>
<section id="design">
<h2><a class="toc-backref" href="#id2" role="doc-backlink">Design</a><a class="headerlink" href="#design" title="Link to this heading">¶</a></h2>
<section id="chunk-header">
<h3>Chunk Header<a class="headerlink" href="#chunk-header" title="Link to this heading">¶</a></h3>
<p>Every chunk of heap memory will be preceded by a chunk header. This has two
purposes, the first one being to store various information about the chunk,
the second one being to detect potential heap overflows. In order to achieve
this, the header will be checksumed, involving the pointer to the chunk itself
and a global secret. Any corruption of the header will be detected when said
header is accessed, and the process terminated.</p>
<p>The following information is stored in the header:</p>
<ul class="simple">
<li><p>the 16-bit checksum;</p></li>
<li><p>the user requested size for that chunk, which is necessary for reallocation
purposes;</p></li>
<li><p>the state of the chunk (available, allocated or quarantined);</p></li>
<li><p>the allocation type (malloc, new, new[] or memalign), to detect potential
mismatches in the allocation APIs used;</p></li>
<li><p>whether or not the chunk is offseted (ie: if the chunk beginning is different
than the backend allocation beginning, which is most often the case with some
aligned allocations);</p></li>
<li><p>the associated offset;</p></li>
<li><p>a 16-bit salt.</p></li>
</ul>
<p>On x64, which is currently the only architecture supported, the header fits
within 16-bytes, which works nicely with the minimum alignment requirements.</p>
<p>The checksum is computed as a CRC32 (requiring the SSE 4.2 instruction set)
of the global secret, the chunk pointer itself, and the 16 bytes of header with
the checksum field zeroed out.</p>
<p>The header is atomically loaded and stored to prevent races (this requires
platform support such as the cmpxchg16b instruction). This is important as two
consecutive chunks could belong to different threads. We also want to avoid
any type of double fetches of information located in the header, and use local
copies of the header for this purpose.</p>
</section>
<section id="delayed-freelist">
<h3>Delayed Freelist<a class="headerlink" href="#delayed-freelist" title="Link to this heading">¶</a></h3>
<p>A delayed freelist allows us to not return a chunk directly to the backend, but
to keep it aside for a while. Once a criterion is met, the delayed freelist is
emptied, and the quarantined chunks are returned to the backend. This helps
mitigate use-after-free vulnerabilities by reducing the determinism of the
allocation and deallocation patterns.</p>
<p>This feature is using the Sanitizer’s Quarantine as its base, and the amount of
memory that it can hold is configurable by the user (see the Options section
below).</p>
</section>
<section id="randomness">
<h3>Randomness<a class="headerlink" href="#randomness" title="Link to this heading">¶</a></h3>
<p>It is important for the allocator to not make use of fixed addresses. We use
the dynamic base option for the SizeClassAllocator, allowing us to benefit
from the randomness of mmap.</p>
</section>
</section>
<section id="usage">
<h2><a class="toc-backref" href="#id3" role="doc-backlink">Usage</a><a class="headerlink" href="#usage" title="Link to this heading">¶</a></h2>
<section id="library">
<h3>Library<a class="headerlink" href="#library" title="Link to this heading">¶</a></h3>
<p>The allocator static library can be built from the LLVM build tree thanks to
the “scudo” CMake rule. The associated tests can be exercised thanks to the
“check-scudo” CMake rule.</p>
<p>Linking the static library to your project can require the use of the
“whole-archive” linker flag (or equivalent), depending on your linker.
Additional flags might also be necessary.</p>
<p>Your linked binary should now make use of the Scudo allocation and deallocation
functions.</p>
</section>
<section id="options">
<h3>Options<a class="headerlink" href="#options" title="Link to this heading">¶</a></h3>
<p>Several aspects of the allocator can be configured through environment options,
following the usual ASan options syntax, through the variable SCUDO_OPTIONS.</p>
<p>For example: SCUDO_OPTIONS=”DeleteSizeMismatch=1:QuarantineSizeMb=16”.</p>
<p>The following options are available:</p>
<ul class="simple">
<li><p>QuarantineSizeMb (integer, defaults to 64): the size (in Mb) of quarantine
used to delay the actual deallocation of chunks. Lower value may reduce
memory usage but decrease the effectiveness of the mitigation; a negative
value will fallback to a default of 64Mb;</p></li>
<li><p>ThreadLocalQuarantineSizeKb (integer, default to 1024): the size (in Kb) of
per-thread cache used to offload the global quarantine. Lower value may
reduce memory usage but might increase the contention on the global
quarantine.</p></li>
<li><p>DeallocationTypeMismatch (boolean, defaults to true): whether or not we report
errors on malloc/delete, new/free, new/delete[], etc;</p></li>
<li><p>DeleteSizeMismatch (boolean, defaults to true): whether or not we report
errors on mismatch between size of new and delete;</p></li>
<li><p>ZeroContents (boolean, defaults to false): whether or not we zero chunk
contents on allocation and deallocation.</p></li>
</ul>
</section>
</section>
</section>


            <div class="clearer"></div>
          </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="Related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="AliasAnalysis.html" title="LLVM Alias Analysis Infrastructure"
             >next</a> |</li>
        <li class="right" >
          <a href="LibFuzzer.html" title="libFuzzer – a library for coverage-guided fuzz testing."
             >previous</a> |</li>
  <li><a href="https://llvm.org/">LLVM Home</a>&nbsp;|&nbsp;</li>
  <li><a href="index.html">Documentation</a>&raquo;</li>

        <li class="nav-item nav-item-this"><a href="">Scudo Hardened Allocator</a></li> 
      </ul>
    </div>
    <div class="footer" role="contentinfo">
    &#169; Copyright 2003-2025, LLVM Project.
      Last updated on 2025-10-28.
      Created using <a href="https://www.sphinx-doc.org/">Sphinx</a> 8.1.3.
    </div>
  </body>
</html>